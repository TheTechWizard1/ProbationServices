<!-- templates/api/admin_dashboard.html -->
{% extends 'api/base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - ProbationServices{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div class="btn-group">
            <a href="/admin/" class="btn btn-outline-warning">
                <i class="fas fa-cog"></i> –ê–¥–º–∏–Ω–∫–∞ Django
            </a>
            <a href="{% url 'export_tickets_csv' %}" class="btn btn-outline-success">
                <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç CSV
            </a>
            <a href="{% url 'profile' %}" class="btn btn-outline-primary">
                <i class="fas fa-user"></i> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
            </a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_tickets }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_instructions }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_views }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-eye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫ -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <h2 class="text-danger">{{ open_tickets }}</h2>
                                    <p class="mb-0">–ù–æ–≤—ã—Ö</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h2 class="text-warning">{{ in_progress_tickets }}</h2>
                                    <p class="mb-0">–í —Ä–∞–±–æ—Ç–µ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-success">
                                <div class="card-body">
                                    <h2 class="text-success">{{ resolved_tickets }}</h2>
                                    <p class="mb-0">–†–µ—à–µ–Ω–æ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h2 class="text-primary">{{ clients_count }}</h2>
                                    <p class="mb-0">–ö–ª–∏–µ–Ω—Ç–æ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h2 class="text-warning">{{ specialists_count }}</h2>
                                    <p class="mb-0">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <h2 class="text-danger">{{ admins_count }}</h2>
                                    <p class="mb-0">–ê–¥–º–∏–Ω–æ–≤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</h6>
                </div>
                <div class="card-body">
                    {% if recent_tickets %}
                    <div class="list-group">
                        {% for ticket in recent_tickets %}
                        <a href="{% url 'ticket_detail' ticket.id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">#{{ ticket.id }}: {{ ticket.title }}</h6>
                                <small>
                                    {% if ticket.status == 'open' %}
                                        <span class="badge bg-danger">–ù–æ–≤–∞—è</span>
                                    {% elif ticket.status == 'in_progress' %}
                                        <span class="badge bg-warning">–í —Ä–∞–±–æ—Ç–µ</span>
                                    {% else %}
                                        <span class="badge bg-success">–†–µ—à–µ–Ω–∞</span>
                                    {% endif %}
                                </small>
                            </div>
                            <p class="mb-1">{{ ticket.description|truncatewords:10 }}</p>
                            <small class="text-muted">
                                {{ ticket.created_by.username }} ‚Ä¢ {{ ticket.created_at|date:"d.m.Y H:i" }}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">–ù–µ—Ç –∑–∞—è–≤–æ–∫</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h6>
                </div>
                <div class="card-body">
                    {% if popular_instructions %}
                    <div class="list-group">
                        {% for instruction in popular_instructions %}
                        <a href="{% url 'instruction_detail' instruction.id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ instruction.title }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-eye"></i> {{ instruction.view_count }}
                                </small>
                            </div>
                            <p class="mb-1">{{ instruction.content|truncatewords:8 }}</p>
                            <small class="text-muted">
                                {{ instruction.get_category_display }} ‚Ä¢ {{ instruction.created_at|date:"d.m.Y" }}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">–ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-dark">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="{% url 'api_docs' %}" class="btn btn-outline-info">
                            <i class="fas fa-code"></i> API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
                        </a>
                        <a href="{% url 'instruction_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-book"></i> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
                        </a>
                        <a href="{% url 'ticket_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-ticket-alt"></i> –í—Å–µ –∑–∞—è–≤–∫–∏
                        </a>
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#quickStatsModal">
                            <i class="fas fa-chart-pie"></i> –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="modal fade" id="quickStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–ó–∞—è–≤–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h6>
                        <ul class="list-group">
                            {% for category in categories_stats %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ category.category__name|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}
                                <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>–ó–∞—è–≤–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π
                                <span class="badge bg-dark rounded-pill">{{ urgent_tickets }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                üü† –í—ã—Å–æ–∫–∏–π
                                <span class="badge bg-danger rounded-pill">{{ high_tickets }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                üü° –°—Ä–µ–¥–Ω–∏–π
                                <span class="badge bg-warning rounded-pill">{{ medium_tickets }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                üü¢ –ù–∏–∑–∫–∏–π
                                <span class="badge bg-success rounded-pill">{{ low_tickets }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.border-left-primary { border-left: 0.25rem solid #4e73df!important; }
.border-left-success { border-left: 0.25rem solid #1cc88a!important; }
.border-left-info { border-left: 0.25rem solid #36b9cc!important; }
.border-left-warning { border-left: 0.25rem solid #f6c23e!important; }
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.addEventListener('DOMContentLoaded', function() {
    var quickStatsModal = document.getElementById('quickStatsModal');
    if (quickStatsModal) {
        var modal = new bootstrap.Modal(quickStatsModal);
    }
});
</script>
{% endblock %}