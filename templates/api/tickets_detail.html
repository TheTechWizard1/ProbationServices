{% extends 'api/base.html' %}

{% block title %}–ó–∞—è–≤–∫–∞ #{{ ticket.id }} - ProbationServices{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li class="breadcrumb-item"><a href="{% url 'ticket_list' %}">–ú–æ–∏ –∑–∞—è–≤–∫–∏</a></li>
            <li class="breadcrumb-item active">–ó–∞—è–≤–∫–∞ #{{ ticket.id }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">–ó–∞—è–≤–∫–∞ #{{ ticket.id }}: {{ ticket.title }}</h4>
                    <div>
                        {% if ticket.status == 'open' %}
                            <span class="badge bg-danger fs-6">üÜï –ù–æ–≤–∞—è</span>
                        {% elif ticket.status == 'in_progress' %}
                            <span class="badge bg-warning fs-6">üîÑ –í —Ä–∞–±–æ—Ç–µ</span>
                        {% elif ticket.status == 'resolved' %}
                            <span class="badge bg-success fs-6">‚úÖ –†–µ—à–µ–Ω–∞</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</h6>
                        <p class="card-text">{{ ticket.description|linebreaks }}</p>
                    </div>

                    {% if ticket.solution %}
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> –†–µ—à–µ–Ω–∏–µ:</h6>
                        <p class="mb-0">{{ ticket.solution|linebreaks }}</p>
                        {% if ticket.resolved_at %}
                        <small class="text-muted">
                            –†–µ—à–µ–Ω–æ: {{ ticket.resolved_at|date:"d.m.Y H:i" }}
                        </small>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ -->
                    {% if user.profile.role in 'specialist,admin' and ticket.status != 'resolved' %}
                    <div class="border-top pt-3 mt-3">
                        <h6>–î–µ–π—Å—Ç–≤–∏—è:</h6>
                        <div class="btn-group" role="group">
                            {% if ticket.status == 'open' %}
                            <form method="post" action="{% url 'api_ticket_assign' ticket.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="fas fa-user-check"></i> –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
                                </button>
                            </form>
                            {% endif %}

                            {% if ticket.assigned_to == user or user.profile.role == 'admin' %}
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#resolveModal">
                                <i class="fas fa-check"></i> –†–µ—à–∏—Ç—å
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer text-muted">
                    <small>
                        –°–æ–∑–¥–∞–Ω–∞: {{ ticket.created_at|date:"d.m.Y H:i" }} |
                        –û–±–Ω–æ–≤–ª–µ–Ω–∞: {{ ticket.updated_at|date:"d.m.Y H:i" }}
                    </small>
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
        <div class="col-lg-4">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong></td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ ticket.get_category_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong></td>
                            <td>
                                {% if ticket.priority == 'low' %}
                                    <span class="badge bg-success">üü¢ –ù–∏–∑–∫–∏–π</span>
                                {% elif ticket.priority == 'medium' %}
                                    <span class="badge bg-warning">üü° –°—Ä–µ–¥–Ω–∏–π</span>
                                {% elif ticket.priority == 'high' %}
                                    <span class="badge bg-danger">üü† –í—ã—Å–æ–∫–∏–π</span>
                                {% elif ticket.priority == 'urgent' %}
                                    <span class="badge bg-dark">üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å:</strong></td>
                            <td>{{ ticket.created_by.username }}</td>
                        </tr>
                        <tr>
                            <td><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong></td>
                            <td>
                                {% if ticket.assigned_to %}
                                    {{ ticket.assigned_to.username }}
                                {% else %}
                                    <span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-bolt"></i> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                        </a>
                        {% if user.profile.role in 'specialist,admin' %}
                        <a href="/admin/api/ticket/{{ ticket.id }}/change/" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
{% if user.profile.role in 'specialist,admin' %}
<div class="modal fade" id="resolveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #{{ ticket.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'api_ticket_resolve' ticket.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="solution" class="form-label">–û–ø–∏—à–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                        <textarea class="form-control" id="solution" name="solution" rows="4"
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –±—ã–ª–∞ —Ä–µ—à–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}