<!-- templates/api/tickets.html -->
{% extends 'api/base.html' %}
{% load static %}

{% block title %}
    {% if user.profile.role in 'specialist,admin' %}
        –í—Å–µ –∑–∞—è–≤–∫–∏ - ProbationServices
    {% else %}
        –ú–æ–∏ –∑–∞—è–≤–∫–∏ - ProbationServices
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid px-lg-5 py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-ticket-alt"></i>
                {% if user.profile.role in 'specialist,admin' %}
                    –í—Å–µ –∑–∞—è–≤–∫–∏
                {% else %}
                    –ú–æ–∏ –∑–∞—è–≤–∫–∏
                {% endif %}
            </li>
        </ol>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row align-items-center mb-5">
        <div class="col-lg-8">
            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="icon-wrapper bg-primary bg-opacity-10 rounded-3 p-3">
                    <i class="fas fa-ticket-alt text-primary fs-2"></i>
                </div>
                <div>
                    <h1 class="display-5 fw-bold mb-2">
                        {% if user.profile.role in 'specialist,admin' %}
                            –í—Å–µ –∑–∞—è–≤–∫–∏
                        {% else %}
                            –ú–æ–∏ –∑–∞—è–≤–∫–∏
                        {% endif %}
                    </h1>
                    <p class="lead text-muted mb-0">
                        {% if user.profile.role in 'specialist,admin' %}
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                        {% else %}
                            –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å –≤–∞—à–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{% url 'ticket_create' %}" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm hover-lift">
                <i class="fas fa-plus-circle me-2"></i> –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                <small class="d-block fw-normal mt-1" style="font-size: 0.8rem;">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 15 –º–∏–Ω</small>
            </a>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="card border-0 shadow-lg mb-5">
        <div class="card-body p-4">
            <div class="row g-4">
                <div class="col-lg-6">
                    <form method="get" class="search-form">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-transparent border-end-0">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text"
                                   class="form-control border-start-0 ps-2"
                                   name="search"
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
                                   value="{{ request.GET.search }}"
                                   style="font-size: 1.1rem;">
                        </div>
                    </form>
                </div>

                <div class="col-lg-6">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <select class="form-select form-select-lg" name="status" id="statusFilter">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>üÜï –ù–æ–≤–∞—è</option>
                                <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                                <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>‚úÖ –†–µ—à–µ–Ω–∞</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <select class="form-select form-select-lg" name="priority" id="priorityFilter">
                                <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                                <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>üü¢ –ù–∏–∑–∫–∏–π</option>
                                <option value="medium" {% if request.GET.priority == 'medium' %}selected{% endif %}>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>üü† –í—ã—Å–æ–∫–∏–π</option>
                                <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12 d-flex justify-content-between">
                    <button type="submit" form="filterForm" class="btn btn-primary px-4 rounded-pill">
                        <i class="fas fa-filter me-2"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary rounded-pill">
                        <i class="fas fa-times me-2"></i> –°–±—Ä–æ—Å–∏—Ç—å
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-dark bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-ticket-alt text-dark fs-3"></i>
                        </div>
                        <div>
                            <h2 class="mb-0 fw-bold">{{ total_count }}</h2>
                            <p class="text-muted mb-0">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-dark bg-opacity-10 text-dark">
                            +{{ new_today|default:"0" }} —Å–µ–≥–æ–¥–Ω—è
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-exclamation-circle text-danger fs-3"></i>
                        </div>
                        <div>
                            <h2 class="mb-0 fw-bold">{{ open_tickets_count }}</h2>
                            <p class="text-muted mb-0">–ù–æ–≤—ã—Ö</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-danger bg-opacity-10 text-danger">
                            <i class="fas fa-clock me-1"></i> –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-tasks text-warning fs-3"></i>
                        </div>
                        <div>
                            <h2 class="mb-0 fw-bold">{{ in_progress_tickets_count }}</h2>
                            <p class="text-muted mb-0">–í —Ä–∞–±–æ—Ç–µ</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-warning bg-opacity-10 text-warning">
                            –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {{ avg_resolution_time|default:"45" }} –º–∏–Ω
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-success bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-check-circle text-success fs-3"></i>
                        </div>
                        <div>
                            <h2 class="mb-0 fw-bold">{{ resolved_tickets_count }}</h2>
                            <p class="text-muted mb-0">–†–µ—à–µ–Ω–æ</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-success bg-opacity-10 text-success">
                            <i class="fas fa-trophy me-1"></i> {{ resolved_percent|default:"85" }}% —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-list me-2"></i> –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                        </h5>
                        <span class="badge bg-primary rounded-pill px-3 py-2">
                            <i class="fas fa-search me-1"></i> –ù–∞–π–¥–µ–Ω–æ: {{ tickets.paginator.count }}
                        </span>
                    </div>
                </div>

                <div class="card-body p-0">
                    {% if tickets %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">ID</th>
                                    <th>–¢–µ–º–∞</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                    {% if user.profile.role in 'specialist,admin' %}
                                    <th>–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                                    <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                                    <th class="text-end pe-4">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in tickets %}
                                <tr class="ticket-row hover-lift">
                                    <td class="ps-4 fw-bold">#{{ ticket.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                {% if ticket.status == 'open' %}
                                                <div class="icon-wrapper bg-danger bg-opacity-10 rounded-3 p-2">
                                                    <i class="fas fa-inbox text-danger"></i>
                                                </div>
                                                {% elif ticket.status == 'in_progress' %}
                                                <div class="icon-wrapper bg-warning bg-opacity-10 rounded-3 p-2">
                                                    <i class="fas fa-tasks text-warning"></i>
                                                </div>
                                                {% elif ticket.status == 'resolved' %}
                                                <div class="icon-wrapper bg-success bg-opacity-10 rounded-3 p-2">
                                                    <i class="fas fa-check text-success"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <a href="{% url 'ticket_detail' ticket.id %}"
                                                   class="text-decoration-none fw-bold text-dark d-block mb-1">
                                                    {{ ticket.title|truncatechars:50 }}
                                                </a>
                                                {% if ticket.description %}
                                                <small class="text-muted d-block">
                                                    {{ ticket.description|truncatechars:80 }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                            {{ ticket.get_category_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if ticket.status == 'open' %}
                                            <span class="badge bg-danger rounded-pill px-3 py-2">
                                                <i class="fas fa-clock me-1"></i> –ù–æ–≤–∞—è
                                            </span>
                                        {% elif ticket.status == 'in_progress' %}
                                            <span class="badge bg-warning rounded-pill px-3 py-2">
                                                <i class="fas fa-tools me-1"></i> –í —Ä–∞–±–æ—Ç–µ
                                            </span>
                                        {% elif ticket.status == 'resolved' %}
                                            <span class="badge bg-success rounded-pill px-3 py-2">
                                                <i class="fas fa-check me-1"></i> –†–µ—à–µ–Ω–∞
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ticket.priority == 'low' %}
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                                üü¢ –ù–∏–∑–∫–∏–π
                                            </span>
                                        {% elif ticket.priority == 'medium' %}
                                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">
                                                üü° –°—Ä–µ–¥–Ω–∏–π
                                            </span>
                                        {% elif ticket.priority == 'high' %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                                                üü† –í—ã—Å–æ–∫–∏–π
                                            </span>
                                        {% elif ticket.priority == 'urgent' %}
                                            <span class="badge bg-dark bg-opacity-10 text-dark border border-dark border-opacity-25">
                                                üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã–π
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-muted">
                                            <div class="fw-medium">{{ ticket.created_at|date:"d.m.Y" }}</div>
                                            <small>{{ ticket.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    {% if user.profile.role in 'specialist,admin' %}
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                                    {{ ticket.created_by.username|first|upper }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ ticket.created_by.username }}</div>
                                                <small class="text-muted">{{ ticket.created_by.get_full_name|default:"" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if ticket.assigned_to %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle">
                                                    {{ ticket.assigned_to.username|first|upper }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ ticket.assigned_to.username }}</div>
                                                <small class="text-muted">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</small>
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-muted fst-italic">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="btn-group">
                                            <a href="{% url 'ticket_detail' ticket.id %}"
                                               class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if user.profile.role == 'admin' %}
                                            <button type="button" class="btn btn-sm btn-outline-warning rounded-pill px-3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                    {% if tickets.has_other_pages %}
                    <div class="border-top pt-4 pb-3 px-4">
                        <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                            <ul class="pagination justify-content-center">
                                {% if tickets.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.priority %}priority={{ request.GET.priority }}&{% endif %}page=1"
                                       aria-label="–ü–µ—Ä–≤–∞—è">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.priority %}priority={{ request.GET.priority }}&{% endif %}page={{ tickets.previous_page_number }}"
                                       aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                                {% endif %}

                                {% for num in tickets.paginator.page_range %}
                                    {% if num >= tickets.number|add:"-2" and num <= tickets.number|add:"2" %}
                                    <li class="page-item {% if tickets.number == num %}active{% endif %}">
                                        <a class="page-link"
                                           href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.priority %}priority={{ request.GET.priority }}&{% endif %}page={{ num }}">
                                            {{ num }}
                                        </a>
                                    </li>
                                    {% endif %}
                                {% endfor %}

                                {% if tickets.has_next %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.priority %}priority={{ request.GET.priority }}&{% endif %}page={{ tickets.next_page_number }}"
                                       aria-label="–°–ª–µ–¥—É—é—â–∞—è">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}{% if request.GET.priority %}priority={{ request.GET.priority }}&{% endif %}page={{ tickets.paginator.num_pages }}"
                                       aria-label="–ü–æ—Å–ª–µ–¥–Ω—è—è">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                            <p class="text-center text-muted mt-2">
                                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ tickets.number }} –∏–∑ {{ tickets.paginator.num_pages }}
                            </p>
                        </nav>
                    </div>
                    {% endif %}

                    {% else %}
                    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞—è–≤–æ–∫ –Ω–µ—Ç -->
                    <div class="text-center py-6">
                        <div class="mb-4">
                            <i class="fas fa-search fa-4x text-muted opacity-25"></i>
                        </div>
                        <h3 class="mb-3">
                            {% if request.GET.search or request.GET.status or request.GET.priority %}
                                –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                            {% else %}
                                {% if user.profile.role in 'specialist,admin' %}
                                    –ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç
                                {% else %}
                                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫
                                {% endif %}
                            {% endif %}
                        </h3>
                        <p class="text-muted mb-4 lead">
                            {% if request.GET.search or request.GET.status or request.GET.priority %}
                                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ <a href="{% url 'ticket_list' %}" class="text-decoration-none">—Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>.
                            {% else %}
                                {% if user.profile.role in 'specialist,admin' %}
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –∑–∞—è–≤–∫–∏.
                                {% else %}
                                    –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–æ—â–∏.
                                {% endif %}
                            {% endif %}
                        </p>
                        <a href="{% url 'ticket_create' %}" class="btn btn-primary btn-lg rounded-pill px-4">
                            <i class="fas fa-plus-circle me-2"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞—è–≤–æ–∫ */
    .search-form .input-group:focus-within {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        border-radius: 10px;
    }

    .hover-lift {
        transition: all 0.3s ease;
    }

    .ticket-row:hover {
        transform: translateX(5px);
        background-color: rgba(13, 110, 253, 0.03) !important;
    }

    .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .bg-opacity-10 {
        --bs-bg-opacity: 0.1;
    }

    .avatar-sm {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-title {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .table tbody tr {
        border-bottom: 1px solid #f0f0f0;
    }

    .table tbody tr:last-child {
        border-bottom: 0;
    }

    .badge.border {
        border-width: 1px !important;
    }
</style>

<form id="filterForm" method="get" style="display: none;">
    {% for key, value in request.GET.items %}
        {% if key != 'page' %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
    {% endfor %}
</form>

<script>
    // JavaScript –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filterForm');
        const searchInput = document.querySelector('input[name="search"]');
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters() {
            // –û—á–∏—â–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            while (filterForm.firstChild) {
                filterForm.removeChild(filterForm.firstChild);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (searchInput.value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'search';
                input.value = searchInput.value;
                filterForm.appendChild(input);
            }

            if (statusFilter.value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'status';
                input.value = statusFilter.value;
                filterForm.appendChild(input);
            }

            if (priorityFilter.value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'priority';
                input.value = priorityFilter.value;
                filterForm.appendChild(input);
            }

            filterForm.submit();
        }

        // –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateFilters();
            }
        });

        statusFilter.addEventListener('change', updateFilters);
        priorityFilter.addEventListener('change', updateFilters);

        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"
        document.querySelector('button[form="filterForm"]').addEventListener('click', function(e) {
            e.preventDefault();
            updateFilters();
        });

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
        const searchParam = new URLSearchParams(window.location.search).get('search');
        if (searchParam && searchParam.trim() !== '') {
            const regex = new RegExp(`(${searchParam.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            document.querySelectorAll('.ticket-row a.fw-bold.text-dark').forEach(link => {
                link.innerHTML = link.textContent.replace(regex, '<mark class="bg-warning bg-opacity-25">$1</mark>');
            });
        }
    });
</script>
{% endblock %}